<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æˆ‘çš„å°é‡‘åº“</title>
    <style>
        :root { --bg: #f2f2f7; --card: #ffffff; --text: #000; --red: #ff3b30; --green: #34c759; }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --card: #1c1c1e; --text: #fff; }
        }
        body { margin: 0; padding: 20px; padding-top: 50px; background: var(--bg); font-family: -apple-system, sans-serif; color: var(--text); -webkit-user-select: none; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: bold; }
        .btn { font-size: 20px; padding: 8px; cursor: pointer; background: rgba(128,128,128,0.1); border-radius: 50%; width: 32px; height: 32px; text-align: center; line-height: 32px; }

        .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .left { display: flex; flex-direction: column; }
        .name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .code { font-size: 12px; opacity: 0.5; }
        .right { text-align: right; }
        .rate { font-size: 18px; font-weight: bold; display: block; }
        .profit { font-size: 14px; font-weight: 500; margin-top: 4px; }
        
        .up { color: var(--red); }
        .down { color: var(--green); }
        
        .blur .profit { filter: blur(6px); opacity: 0.5; }
        .blur .total-area { display: none; }

        .settings-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(128,128,128,0.3); padding: 10px 20px; border-radius: 20px; font-size: 14px; backdrop-filter: blur(10px); font-weight: 600; cursor: pointer;}
        
        #status-msg { text-align: center; color: #999; font-size: 12px; margin-top: 50px; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title" id="appTitle">ğŸ’° æˆ‘çš„å°é‡‘åº“</div>
        <div class="btn" onclick="toggleMode()">ğŸ‘ï¸</div>
    </div>

    <div id="fundList"></div>
    <div id="status-msg">æ­£åœ¨è¿æ¥è…¾è®¯æ¥å£...</div>

    <div class="settings-btn" onclick="editConfig()">âš™ï¸ é…ç½®æŒä»“</div>

    <script>
        // === é…ç½®åŒºåŸŸ ===
        let myFunds = JSON.parse(localStorage.getItem('myFunds')) || [
            { code: "021074", shares: 1000 }, 
            { code: "005827", shares: 500 }
        ];
        let isHidden = localStorage.getItem('isHidden') === 'true';

        // === æ¸²æŸ“å‡½æ•° ===
        function render(dataMap) {
            const container = document.getElementById('fundList');
            document.getElementById('status-msg').style.display = 'none';
            document.body.className = isHidden ? 'blur' : '';
            document.getElementById('appTitle').innerText = isHidden ? 'ğŸ“š å•è¯æ‰“å¡' : 'ğŸ’° æˆ‘çš„å°é‡‘åº“';

            let totalProfit = 0;
            let html = '';

            myFunds.forEach(fund => {
                const item = dataMap[fund.code];
                
                if (!item) {
                    html += `<div class="card"><div class="left"><span class="name">åŠ è½½å¤±è´¥</span><span class="code">${fund.code}</span></div></div>`;
                    return;
                }

                // è…¾è®¯æ•°æ®è§£æé€»è¾‘
                // item æ ¼å¼: [ä»£ç , åå­—, æœ€æ–°å‡€å€¼, ç´¯è®¡å‡€å€¼, æ˜¨æ—¥å‡€å€¼, ..., æ¶¨è·Œå¹…, ..., æ›´æ–°æ—¥æœŸ]
                // ç´¢å¼•: 2=æœ€æ–°å‡€å€¼(dwjz), 4=æ˜¨æ—¥å‡€å€¼, 
                // æ³¨æ„ï¼šè…¾è®¯æ¥å£å¯¹äºåœºå¤–åŸºé‡‘ï¼Œé€šå¸¸åªè¿”å›â€œå‡€å€¼â€ï¼Œä¸è¿”å›å®æ—¶çš„â€œä¼°å€¼â€ã€‚
                // å¦‚æœæ˜¯äº¤æ˜“æ—¶é—´ï¼Œå®ƒæ˜¾ç¤ºçš„å¯èƒ½æ˜¯æ˜¨æ—¥å‡€å€¼ï¼Œç›´åˆ°æ™šä¸Šæ›´æ–°ã€‚
                
                const current = parseFloat(item[2]); // æœ€æ–°å‡€å€¼
                const yesterday = parseFloat(item[4]); // æ˜¨æ—¥å‡€å€¼
                
                // å®¹é”™ï¼šå¦‚æœæœ€æ–°å‡€å€¼è¿˜æ²¡å‡ºï¼Œå¯èƒ½ current == yesterday
                let profit = 0;
                let rate = 0;
                
                if(yesterday > 0) {
                    profit = (current - yesterday) * fund.shares;
                    rate = ((current - yesterday) / yesterday) * 100;
                }
                
                totalProfit += profit;
                
                const isUp = rate >= 0;
                const rateStr = rate.toFixed(2);

                html += `
                <div class="card">
                    <div class="left">
                        <span class="name">${item[1].substring(0, 8)}</span>
                        <span class="code">${fund.code}</span>
                    </div>
                    <div class="right">
                        <span class="rate ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${rateStr}%</span>
                        <span class="profit ${profit >= 0 ? 'up' : 'down'}">${profit > 0 ? '+' : ''}${profit.toFixed(1)}</span>
                    </div>
                </div>`;
            });

            if (!isHidden) {
                html += `<div class="total-area" style="text-align:center; margin-top:20px;">
                    <div style="font-size:14px; color:gray;">ä»Šæ—¥æ”¶ç›Š (Tencentæº)</div>
                    <div style="font-size:28px; font-weight:bold; margin-top:5px; color:${totalProfit>=0?'#ff3b30':'#34c759'}">
                        ${totalProfit>0?'+':''}${totalProfit.toFixed(1)}
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        // === æ ¸å¿ƒï¼šè…¾è®¯æ¥å£ (GTimg) ===
        function fetchData() {
            document.getElementById('status-msg').style.display = 'block';
            document.getElementById('status-msg').innerText = "æ­£åœ¨è¿æ¥è…¾è®¯äº‘...";

            // æ„é€ URL: http://qt.gtimg.cn/q=jjä»£ç ,jjä»£ç 
            const codes = myFunds.map(f => 'jj' + f.code).join(',');
            const script = document.createElement('script');
            script.src = `https://qt.gtimg.cn/q=${codes}&t=${Date.now()}`;
            
            script.onload = () => {
                const dataMap = {};
                myFunds.forEach(fund => {
                    // è…¾è®¯è¿”å›æ ¼å¼: v_jjä»£ç  = "..."
                    const varName = `v_jj${fund.code}`;
                    const dataStr = window[varName];
                    if (dataStr) {
                        // è…¾è®¯æ•°æ®æ˜¯ç”¨ ~ åˆ†å‰²çš„ï¼Œæˆ–è€…ç”¨ , åˆ†å‰²ï¼Œå–å†³äºæ¥å£
                        // jjæ¥å£é€šå¸¸æ˜¯: ä»£ç ,åå­—,æœ€æ–°,ç´¯è®¡,æ˜¨æ—¥...
                        const parts = dataStr.split(','); 
                        if(parts.length > 3) {
                            dataMap[fund.code] = parts;
                        }
                    }
                });
                render(dataMap);
            };
            
            script.onerror = () => {
                document.getElementById('status-msg').innerHTML = `
                    <span style="color:#ff3b30">è¿æ¥è¢«æ‹¦æˆª</span><br>
                    1. è¯·å…³é—­æ‰‹æœºçš„â€œå¹¿å‘Šæ‹¦æˆªâ€æ’ä»¶<br>
                    2. å°è¯•åˆ‡æ¢ Wi-Fi / 5G ç½‘ç»œ
                `;
            };
            
            document.body.appendChild(script);
            setTimeout(() => { if(script.parentNode) script.parentNode.removeChild(script); }, 2000);
        }

        function toggleMode() {
            isHidden = !isHidden;
            localStorage.setItem('isHidden', isHidden);
            fetchData();
        }

        function editConfig() {
            const defaultStr = myFunds.map(f => `${f.code},${f.shares}`).join('; ');
            const input = prompt("ä¿®æ”¹æŒä»“ (æ ¼å¼: ä»£ç ,ä»½é¢):", defaultStr);
            if (input) {
                try {
                    const newFunds = input.split(/[;ï¼›]/).map(str => { 
                        const parts = str.trim().split(/[,ï¼Œ]/); 
                        if (parts.length < 2) return null;
                        return { code: parts[0].trim(), shares: parseFloat(parts[1]) };
                    }).filter(item => item !== null);
                    if(newFunds.length > 0) {
                        myFunds = newFunds;
                        localStorage.setItem('myFunds', JSON.stringify(myFunds));
                        fetchData(); 
                    }
                } catch (e) { alert("æ ¼å¼é”™è¯¯"); }
            }
        }

        fetchData();
        setInterval(fetchData, 60000);
    </script>
</body>
</html>
