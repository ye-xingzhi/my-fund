<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‘¸é±¼åŠ©æ‰‹">
    <title>æˆ‘çš„åŸºé‡‘</title>
    <style>
        :root { --bg: #f2f2f7; --card: #ffffff; --text: #000; --red: #ff3b30; --green: #34c759; }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --card: #1c1c1e; --text: #fff; }
        }
        body { margin: 0; padding: 20px; padding-top: 50px; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; color: var(--text); -webkit-user-select: none; }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: bold; }
        .mask-btn { font-size: 24px; cursor: pointer; }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .left { display: flex; flex-direction: column; }
        .name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .code { font-size: 12px; opacity: 0.5; }
        .right { text-align: right; }
        .rate { font-size: 18px; font-weight: bold; display: block; }
        .profit { font-size: 14px; font-weight: 500; margin-top: 4px; }
        
        /* é¢œè‰² */
        .up { color: var(--red); }
        .down { color: var(--green); }
        
        /* æ‘¸é±¼æ¨¡å¼ï¼ˆéšè—é‡‘é¢ï¼‰ */
        .blur .profit { filter: blur(5px); opacity: 0.5; }

        /* åº•éƒ¨é…ç½®æŒ‰é’® */
        .settings { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(128,128,128,0.2); padding: 8px 16px; border-radius: 20px; font-size: 12px; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <div class="header">
        <div class="title" id="appTitle">ğŸ“š å•è¯æ‰“å¡</div>
        <div class="mask-btn" onclick="toggleMode()">ğŸ‘ï¸</div>
    </div>

    <div id="fundList">
        <div style="text-align:center; color:#999; margin-top:50px;">åŠ è½½ä¸­...</div>
    </div>

    <div class="settings" onclick="editConfig()">âš™ï¸ é…ç½®æŒä»“</div>

    <script>
        // === æ ¸å¿ƒé€»è¾‘ ===
        
        // 1. è¯»å–æœ¬åœ°é…ç½® (å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤)
        let myFunds = JSON.parse(localStorage.getItem('myFunds')) || [
            { code: "021074", shares: 1000 }, // é»˜è®¤ç¤ºä¾‹ï¼šåå¤é»„é‡‘
            { code: "005827", shares: 500 }   // é»˜è®¤ç¤ºä¾‹
        ];

        let isHidden = localStorage.getItem('isHidden') === 'true';

        // 2. æ¸²æŸ“é¡µé¢
        function render() {
            const container = document.getElementById('fundList');
            document.body.className = isHidden ? 'blur' : '';
            document.getElementById('appTitle').innerText = isHidden ? 'ğŸ“š å•è¯æ‰“å¡' : 'ğŸ’° æˆ‘çš„å°é‡‘åº“';
            
            // å¦‚æœæ•°æ®è¿˜æ²¡å›æ¥ï¼Œä¿æŒåŠ è½½çŠ¶æ€
            if(window.loadedData) {
                let totalProfit = 0;
                let html = '';
                
                myFunds.forEach(fund => {
                    const data = window.loadedData[fund.code];
                    if(!data) return;

                    // è®¡ç®—æ”¶ç›Šï¼š(å½“å‰ä¼°å€¼ - æ˜¨æ—¥å‡€å€¼) * ä»½é¢
                    const profit = (data.gsz - data.dwjz) * fund.shares;
                    totalProfit += profit;
                    
                    const isUp = data.gszzl >= 0;
                    
                    html += `
                    <div class="card">
                        <div class="left">
                            <span class="name">${data.name.substring(0,6)}..</span>
                            <span class="code">${fund.code}</span>
                        </div>
                        <div class="right">
                            <span class="rate ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${data.gszzl}%</span>
                            <span class="profit ${profit >= 0 ? 'up' : 'down'}">${profit > 0 ? '+' : ''}${profit.toFixed(1)}</span>
                        </div>
                    </div>`;
                });
                
                // åº•éƒ¨å¢åŠ æ€»æ”¶ç›Š
                if(!isHidden) {
                    html += `<div style="text-align:center; margin-top:20px; font-weight:bold; font-size:20px; color:${totalProfit>=0?'#ff3b30':'#34c759'}">
                        ä»Šæ—¥é¢„ä¼°: ${totalProfit>0?'+':''}${totalProfit.toFixed(1)}
                    </div>`;
                }
                
                container.innerHTML = html;
            }
        }

        // 3. è·å–æ•°æ® (ä½¿ç”¨ JSONP è§£å†³è·¨åŸŸ)
        function fetchData() {
            const codes = myFunds.map(f => f.code);
            window.loadedData = {};
            let loadedCount = 0;

            codes.forEach(code => {
                const script = document.createElement('script');
                // åŠ ä¸Šæ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                script.src = `https://fundgz.1234567.com.cn/js/gszzl.js?code=${code}&t=${Date.now()}`;
                
                // å®šä¹‰å›è°ƒæ•è·
                // æ¥å£è¿”å›æ ¼å¼: jsonpgz({"fundcode":"...","gszzl":"..."});
                // æˆ‘ä»¬é€šè¿‡é‡å†™ jsonpgz å‡½æ•°æ¥æˆªè·æ•°æ®
                window.jsonpgz = function(data) {
                    window.loadedData[data.fundcode] = data;
                    loadedCount++;
                    if(loadedCount === codes.length) {
                        render();
                    }
                };
                
                script.onerror = () => { loadedCount++; }; // é”™è¯¯ä¹Ÿç»§ç»­
                document.body.appendChild(script);
                // æ¸…ç†æ ‡ç­¾
                setTimeout(() => document.body.removeChild(script), 1000);
            });
        }

        // 4. äº¤äº’åŠŸèƒ½
        function toggleMode() {
            isHidden = !isHidden;
            localStorage.setItem('isHidden', isHidden);
            render();
        }

        function editConfig() {
            const input = prompt("è¯·è¾“å…¥æŒä»“ (æ ¼å¼: ä»£ç ,ä»½é¢; ä»£ç ,ä»½é¢)", 
                myFunds.map(f => `${f.code},${f.shares}`).join('; '));
            
            if (input) {
                try {
                    const newFunds = input.split(';').map(item => {
                        const [c, s] = item.trim().split(/[,ï¼Œ]/); // æ”¯æŒä¸­è‹±æ–‡é€—å·
                        if(!c || !s) throw new Error();
                        return { code: c.trim(), shares: parseFloat(s) };
                    });
                    myFunds = newFunds;
                    localStorage.setItem('myFunds', JSON.stringify(myFunds));
                    alert("ä¿å­˜æˆåŠŸï¼å³å°†åˆ·æ–°");
                    fetchData();
                } catch(e) {
                    alert("æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼š021074,1000; 005827,500");
                }
            }
        }

        // å¯åŠ¨
        fetchData();
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(fetchData, 30000);
        render(); // åˆå§‹æ¸²æŸ“
    </script>
</body>
</html>