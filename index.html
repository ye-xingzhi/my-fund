<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æˆ‘çš„å°é‡‘åº“</title>
    <style>
        :root { --bg: #f2f2f7; --card: #ffffff; --text: #000; --red: #ff3b30; --green: #34c759; }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --card: #1c1c1e; --text: #fff; }
        }
        body { margin: 0; padding: 20px; padding-top: 50px; background: var(--bg); font-family: -apple-system, sans-serif; color: var(--text); -webkit-user-select: none; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: bold; }
        .btn { font-size: 20px; padding: 8px; cursor: pointer; background: rgba(128,128,128,0.1); border-radius: 50%; width: 32px; height: 32px; text-align: center; line-height: 32px; }

        .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .left { display: flex; flex-direction: column; }
        .name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .code { font-size: 12px; opacity: 0.5; }
        .right { text-align: right; }
        .rate { font-size: 18px; font-weight: bold; display: block; }
        .profit { font-size: 14px; font-weight: 500; margin-top: 4px; }
        
        .up { color: var(--red); }
        .down { color: var(--green); }
        
        /* æ‘¸é±¼æ¨¡å¼ */
        .blur .profit { filter: blur(6px); opacity: 0.5; }
        .blur .total-area { display: none; }

        .settings-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(128,128,128,0.3); padding: 10px 20px; border-radius: 20px; font-size: 14px; backdrop-filter: blur(10px); font-weight: 600; cursor: pointer;}
        
        #error-msg { color: var(--red); font-size: 12px; text-align: center; margin-top: 20px; display: none; line-height: 1.5; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title" id="appTitle">ğŸ’° æˆ‘çš„å°é‡‘åº“</div>
        <div class="btn" onclick="toggleMode()">ğŸ‘ï¸</div>
    </div>

    <div id="fundList">
        <div style="text-align:center; color:#999; margin-top:50px;">
            æ­£åœ¨è¿æ¥å®˜æ–¹æ•°æ®...<br>
            <span style="font-size:12px; opacity:0.6">(V3.0 Proxyç‰ˆ)</span>
        </div>
    </div>
    
    <div id="error-msg"></div>

    <div class="settings-btn" onclick="editConfig()">âš™ï¸ é…ç½®æŒä»“</div>

    <script>
        // === 1. åˆå§‹åŒ–é…ç½® ===
        let myFunds = JSON.parse(localStorage.getItem('myFunds')) || [
            { code: "021074", shares: 1000 }, 
            { code: "005827", shares: 500 }
        ];
        let isHidden = localStorage.getItem('isHidden') === 'true';

        // === 2. æ¸²æŸ“å‡½æ•° ===
        function render(dataList) {
            const container = document.getElementById('fundList');
            document.body.className = isHidden ? 'blur' : '';
            document.getElementById('appTitle').innerText = isHidden ? 'ğŸ“š å•è¯æ‰“å¡' : 'ğŸ’° æˆ‘çš„å°é‡‘åº“';

            if(!dataList || dataList.length === 0) return;

            let totalProfit = 0;
            let html = '';

            // å»ºç«‹å­—å…¸æ–¹ä¾¿æŸ¥è¯¢
            const dataMap = {};
            dataList.forEach(d => dataMap[d.fundcode] = d);

            myFunds.forEach(fund => {
                const item = dataMap[fund.code];
                // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½
                if (!item) {
                    html += `<div class="card"><div class="left"><span class="name">åŠ è½½ä¸­...</span><span class="code">${fund.code}</span></div></div>`;
                    return;
                }

                // è®¡ç®—é€»è¾‘ï¼šå¤©å¤©åŸºé‡‘è¿”å›çš„ gsz(å®æ—¶å‡€å€¼) - dwjz(æ˜¨æ—¥å‡€å€¼)
                const currentPrice = parseFloat(item.gsz || item.dwjz); // å¦‚æœæ²¡å¼€ç›˜å°±ç”¨å‡€å€¼
                const yesterdayPrice = parseFloat(item.dwjz);
                const growthRate = parseFloat(item.gszzl || "0");
                
                // åªæœ‰å½“æœ‰å®æ—¶ä¼°å€¼æ—¶æ‰ç®—æ”¶ç›Šï¼Œå¦åˆ™ä¸º0
                let profit = 0;
                if(item.gsz && item.dwjz) {
                     profit = (currentPrice - yesterdayPrice) * fund.shares;
                }
                
                totalProfit += profit;
                const isUp = growthRate >= 0;

                html += `
                <div class="card">
                    <div class="left">
                        <span class="name">${item.name.substring(0, 8)}</span>
                        <span class="code">${fund.code}</span>
                    </div>
                    <div class="right">
                        <span class="rate ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${growthRate}%</span>
                        <span class="profit ${profit >= 0 ? 'up' : 'down'}">${profit > 0 ? '+' : ''}${profit.toFixed(1)}</span>
                    </div>
                </div>`;
            });

            if (!isHidden) {
                html += `<div class="total-area" style="text-align:center; margin-top:20px;">
                    <div style="font-size:14px; color:gray;">ä»Šæ—¥é¢„ä¼°ç›ˆäº</div>
                    <div style="font-size:28px; font-weight:bold; margin-top:5px; color:${totalProfit>=0?'#ff3b30':'#34c759'}">
                        ${totalProfit>0?'+':''}${totalProfit.toFixed(1)}
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        // === 3. æ ¸å¿ƒï¼šé€šè¿‡ Proxy è·å–å®˜æ–¹æ•°æ® ===
        async function fetchData() {
            const promises = myFunds.map(fund => {
                // åŸå§‹ HTTP å®˜æ–¹æ¥å£
                const targetUrl = `http://fundgz.1234567.com.cn/js/gszzl.js?code=${fund.code}&t=${Date.now()}`;
                // ä½¿ç”¨ allorigins ä»£ç†è½¬å‘ (å°† HTTP è½¬ä¸º HTTPS)
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                
                return fetch(proxyUrl)
                    .then(res => {
                        if(!res.ok) throw new Error("Network");
                        return res.text();
                    })
                    .then(text => {
                        // è§£æ JSONP: jsonpgz({...});
                        const match = text.match(/jsonpgz\((.*?)\)/);
                        if(match && match[1]) return JSON.parse(match[1]);
                        return null;
                    })
                    .catch(err => null); // å•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“
            });

            try {
                const results = await Promise.all(promises);
                const validResults = results.filter(r => r !== null);
                
                if (validResults.length > 0) {
                    render(validResults);
                    document.getElementById('error-msg').style.display = 'none';
                } else {
                    throw new Error("æ‰€æœ‰æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                }
            } catch (err) {
                console.error(err);
                document.getElementById('error-msg').style.display = '
